plan:
    package: ./2021.dagger/dagger/prod_image
name: prod_image
inputs:
    app_src:
        dir:
            path: .
            exclude:
                - .circleci
                - .dagger
                - .git
                - .github
                - 2021.dagger
                - 2022.fly
                - _build/dev
                - _build/test
                - assets/node_modules
                - cue.mod
                - dev_docker
                - docker
                - import
                - nginx
                - priv/db
                - priv/uploads
                - script
                - tmp
                - .all-contributorsrc
                - .autocomplete
                - .credo.exs
                - .dockerignore
                - .formatter.exs
                - .envrc
                - .env
                - .gitattributes
                - .gitignore
                - README.md
                - coveralls.json
                - start_dev_stack.sh
                - .kube
                - erl_crash.dump
                - deps
                - _build
                - dagger
    app_version:
        text: 22.12.31+8a0c2ff2e53aafba0bfbebf2250596e47ffdc51d
    build_url:
        text: https://github.com/thechangelog/changelog.com/actions
    build_version:
        text: 22.12.31+8a0c2ff2e53aafba0bfbebf2250596e47ffdc51d
    docker_host:
        text: tcp://100.81.87.121:2375
    dockerhub_password:
        secret: ENC[AES256_GCM,data:Fin0Di/C0774YTGEEqD7m2zk5xU=,iv:ip4B7roo7CltaS1Xws7yeobPvvNISPQgeTUdHoimS0A=,tag:kuy0AokubbBg0J2FiI+AgA==,type:str]
    dockerhub_username:
        text: changelogci
    git_author:
        text: gerhard
    git_sha:
        text: 8a0c2ff2e53aafba0bfbebf2250596e47ffdc51d
    prod_dockerfile:
        text: |
            FROM thechangelog/legacy_assets AS legacy_assets
            FROM thechangelog/runtime:2022-11-13T07.34.05Z

            RUN mkdir /app
            ARG APP_FROM_PATH=.
            COPY ${APP_FROM_PATH} /app
            WORKDIR /app
            RUN echo "Ensure deps are present & OK..." \
              ; ls -lahd deps/*
            RUN echo "Ensure prod bytecode is present & OK..." \
              ; ls -lahd _build/prod/lib/*/ebin
            RUN echo "Ensure prod static assets are present & OK..." \
              ; ls -lah priv/static/cache_manifest.json

            COPY --from=legacy_assets /var/www/wp-content /app/priv/wp-content

            ENV MIX_ENV=prod
            ENV TERM=xterm

            # Used by PromEx for annotations
            ARG GIT_AUTHOR
            ENV GIT_AUTHOR=${GIT_AUTHOR}
            ARG GIT_SHA
            ENV GIT_SHA=${GIT_SHA}
            ARG APP_VERSION
            ENV APP_VERSION=${APP_VERSION}

            ARG BUILD_URL
            ENV BUILD_URL=${BUILD_URL}
            # Used by various tooling to report the identity & origin of this build
            RUN echo "$GIT_SHA" > priv/static/version.txt \
              ; echo "$GIT_AUTHOR" > COMMIT_USER \
              ; echo "$BUILD_URL" > priv/static/build.txt

            EXPOSE 4000

            CMD make on-app-start; mix changelog.static.upload; mix do ecto.create, ecto.migrate, phx.server
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1jl7vc68wfe2carr7qhe83r540fh8ayjensmym5p5ddsky84cvvas0gyr6l
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBOTm5acGNwRTBweERTUy9q
            bXdOWjhZTzJyK0loRGxXU1dxdHpNVTMwb0hrCmlFT0wwMVN5Tys1UDBuZHRmWnFL
            L0F2RmZyQU15SGVFa3FFUGNTZzJFNzgKLS0tIHo5QTBOUndYNXdSc0NjeFI0Y1Za
            UTVMS2FqWklZSlUrelV3eFNyd1hXUU0K6ktvY5PyvsqSG6X/0VVQBnKozzXwUfJQ
            hv8BnEh9dcaFKlYsV32YoC3XocSN9fX73GUeHLouVqaUd/wg5CgspQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2022-12-31T19:13:13Z"
    mac: ENC[AES256_GCM,data:sLEiVe51fDQC54LWWYtASAjFe/TT1wNonmp0Y925Lp1ey9M0VzqUn5y2ANfkGRgpvLNeOL0SyJBPdmmZ1OBtxSzaKzWuwTo9gfxvGspIa8wK0wR6Hkhxyqlh9adxm7aw+GoZTb+xn50Gx4P4J8f58DqUBq3D0LAt6RBChD8bm1U=,iv:26EkL7c9ToPN3AxWRopBLsO4JH3sjYzcEGvprm68Guw=,tag:S4PZZfXViyCalqsqONpmiA==,type:str]
    pgp: []
    encrypted_suffix: secret
    version: 3.7.1
